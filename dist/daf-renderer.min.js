!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).dafRenderer=t()}(this,(function(){"use strict";const e={contentWidth:"600px",mainWidth:"50%",padding:{vertical:"10px",horizontal:"16px"},innerPadding:"4px",outerPadding:"4px",halfway:"50%",fontFamily:{inner:"Rashi",outer:"Rashi",main:"Vilna"},direction:"rtl",fontSize:{main:"15px",side:"10.5px"},lineHeight:{main:"17px",side:"14px"}};function t(n,i=e){const a={};for(const e in i)if(e in n){const s=typeof i[e];typeof n[e]!==s&&console.error(`Option ${e} must be of type ${s}; ${typeof n[e]} was passed.`),a[e]="object"==s?t(n[e],i[e]):n[e]}else a[e]=i[e];return a}function n(e,t,n,i,a,s){let r=document.createElement("div");r.style.font=String(n)+"px "+String(t),r.style.width=String(i)+"px",r.style.lineHeight=String(a)+"px",r.innerHTML=e,s.append(r);let o=Number(r.clientHeight*r.clientWidth);return r.remove(),o}function i(e,t,i,a,s){const r={width:parseFloat(a.contentWidth),padding:{vertical:parseFloat(a.padding.vertical),horizontal:parseFloat(a.padding.horizontal)},halfway:.01*parseFloat(a.halfway),fontFamily:a.fontFamily,fontSize:{main:parseFloat(a.fontSize.main),side:parseFloat(a.fontSize.side)},lineHeight:{main:parseFloat(a.lineHeight.main),side:parseFloat(a.lineHeight.side)},mainWidth:.01*parseFloat(a.mainWidth)},o=Number(r.width*r.mainWidth)-2*r.padding.horizontal,l=Number(r.width*r.halfway)-r.padding.horizontal,d=Number(r.width*(1-r.mainWidth)/2),_={start:4.3*r.lineHeight.side,inner:null,outer:null,end:0,exception:0},h=d*r.padding.vertical,c=e=>4*e*l,p={name:"main",width:o,text:e,lineHeight:r.lineHeight.main,area:n(e,r.fontFamily.main,r.fontSize.main,o,r.lineHeight.main,s),length:null,height:null},m={name:"outer",width:d,text:i,lineHeight:r.lineHeight.side,area:n(i,r.fontFamily.outer,r.fontSize.side,d,r.lineHeight.side,s)-c(r.lineHeight.side),length:null,height:null},u={name:"inner",width:d,text:t,lineHeight:r.lineHeight.side,area:n(t,r.fontFamily.inner,r.fontSize.side,d,r.lineHeight.side,s)-c(r.lineHeight.side),length:null,height:null},g=[p,m,u];g.forEach((e=>e.height=e.area/e.width)),g.forEach((e=>e.unadjustedArea=e.area+c(r.lineHeight.side))),g.forEach((e=>e.unadjustedHeight=e.unadjustedArea/e.width));const y=Array.from(g).sort(((e,t)=>e.height-t.height));if(u.height<=0&&m.height<=0)return console.error("No Commentary"),Error("No Commentary");if(u.height<=_.start&&m.height<=_.start)return console.error("Not Enough Commentary to Fill Four Lines"),Error("Not Enough Commentary");if(u.unadjustedHeight<=_.start||m.unadjustedHeight<=_.start)return u.unadjustedHeight<=_.start?(_.inner=u.unadjustedHeight,_.outer=(m.unadjustedArea-4*r.width*r.lineHeight.side)/d,_.exception=1,_):m.unadjustedHeight<=_.start?(_.outer=m.unadjustedHeight,_.inner=(u.unadjustedArea-4*r.width*r.lineHeight.side)/d,_.exception=2,_):Error("Inner Spacer Error");if("main"===y[0].name){console.log("Double-Wrap"),_.inner=p.area/o,_.outer=_.inner;const e=_.inner*d+h,t=(y[1].area-e)/l;return _.end=t,_}const f=p.area+y[0].area,x=o+d,T=f/x,S="main"==y[1].name?y[2]:y[1];if(T<S.area/S.width){console.log(`Stairs, ${S.name} is the stair`);const e=(e,t,n)=>n*(e-t),t=y[0];return _[t.name]=t.height,_[S.name]=(f-e(T,_[t.name],r.padding.horizontal))/x,_}return console.log("Double-Extend"),_.inner=u.height,_.outer=m.height,_}var a={dafRoot:"styles_dafRoot__1QUlM",outer:"styles_outer__abXQX",inner:"styles_inner__x-amJ",main:"styles_main__BHTRd",spacer:"styles_spacer__2T7TS",outerMid:"styles_outerMid__2WtcY",innerMid:"styles_innerMid__27MCi",mid:"styles_mid__dcgUr",start:"styles_start__AwkfY",end:"styles_end__2wr6A",text:"styles_text__1_7-z"};!function(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style");a.type="text/css","top"===n&&i.firstChild?i.insertBefore(a,i.firstChild):i.appendChild(a),a.styleSheet?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e))}}('/*Keep this as the first rule in the file*/\n.styles_dafRoot__1QUlM {\n  --contentWidth: 0px;\n  --padding-horizontal: 0px;\n  --padding-vertical: 0px;\n  --halfway: 50%;\n\n  --fontFamily-inner: "Rashi";\n  --fontFamily-outer: "Tosafot";\n  --fontFamily-main: "Vilna";\n  --direction: "rtl";\n\n  --fontSize-main: 0px;\n  --fontSize-side: 0px;\n\n  --lineHeight-main: 0px;\n  --lineHeight-side: 0px;\n\n  --mainWidth: 0%;\n  --mainMargin-start: var(--mainWidth);\n  --sidePercent: calc(calc(100% - var(--mainMargin-start)) / 2);\n  --remainderPercent: calc(100% - var(--sidePercent));\n\n  --innerFloat: left;\n  --outerFloat: right;\n\n  --spacerHeights-start: 0px;\n  --spacerHeights-outer: 0px;\n  --spacerHeights-inner: 0px;\n  --spacerHeights-end: 0px;\n\n  /*Edge Cases*/\n  --hasInnerStartGap: 0;\n  --hasOuterStartGap: 0;\n  --innerStartWidth: 50%;\n  --innerPadding: 0px;\n  --outerStartWidth: 50%;\n  --outerPadding: 0px;\n}\n\n/*Containers*/\n.styles_dafRoot__1QUlM,\n.styles_outer__abXQX,\n.styles_inner__x-amJ,\n.styles_main__BHTRd {\n  width: var(--contentWidth);\n  pointer-events: none;\n  box-sizing: content-box;\n}\n\n.styles_outer__abXQX, .styles_inner__x-amJ, .styles_main__BHTRd {\n  position: absolute;\n}\n\n/*Float changes with amud*/\n.styles_inner__x-amJ .styles_spacer__2T7TS,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_outerMid__2WtcY {\n  float: var(--innerFloat);\n}\n\n.styles_outer__abXQX .styles_spacer__2T7TS,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_innerMid__27MCi {\n  float: var(--outerFloat);\n}\n\n/*Spacer widths determined by options*/\n.styles_inner__x-amJ .styles_spacer__2T7TS,\n.styles_outer__abXQX .styles_spacer__2T7TS {\n  width: var(--halfway);\n}\n.styles_spacer__2T7TS.styles_mid__dcgUr {\n  width: var(--remainderPercent);\n}\n\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_start__AwkfY {\n  width: var(--contentWidth);\n}\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_innerMid__27MCi,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_outerMid__2WtcY {\n  width: var(--sidePercent);\n}\n\n/*Spacer heights determined by algorithm*/\n.styles_spacer__2T7TS.styles_start__AwkfY {\n  height: var(--spacerHeights-start);\n}\n\n.styles_spacer__2T7TS.styles_end__2wr6A {\n  height: var(--spacerHeights-end);\n}\n\n.styles_inner__x-amJ .styles_spacer__2T7TS.styles_mid__dcgUr,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_innerMid__27MCi {\n  height: var(--spacerHeights-inner);\n}\n.styles_outer__abXQX .styles_spacer__2T7TS.styles_mid__dcgUr,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_outerMid__2WtcY {\n  height: var(--spacerHeights-outer);\n}\n\n/*Settings to handle edge Cases*/\n\n.styles_inner__x-amJ .styles_spacer__2T7TS.styles_start__AwkfY {\n  width: var(--innerStartWidth);\n  margin-left: var(--innerPadding);\n  margin-right: var(--innerPadding);\n}\n\n.styles_outer__abXQX .styles_spacer__2T7TS.styles_start__AwkfY {\n  width: var(--outerStartWidth);\n  margin-left: var(--outerPadding);\n  margin-right: var(--outerPadding);\n}\n\n.styles_inner__x-amJ .styles_spacer__2T7TS.styles_start__AwkfY{\n  margin-bottom: calc(var(--padding-vertical) * var(--hasInnerStartGap));\n}\n.styles_outer__abXQX .styles_spacer__2T7TS.styles_start__AwkfY {\n  margin-bottom: calc(var(--padding-vertical) * var(--hasOuterStartGap));\n}\n\n.styles_spacer__2T7TS.styles_mid__dcgUr {\n  clear: both;\n}\n\n/*Margins!*/\n.styles_spacer__2T7TS.styles_start__AwkfY,\n.styles_spacer__2T7TS.styles_end__2wr6A,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_innerMid__27MCi,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_outerMid__2WtcY {\n  margin-left: calc(0.5 * var(--padding-horizontal));\n  margin-right: calc(0.5 * var(--padding-horizontal));\n}\n\n.styles_spacer__2T7TS.styles_mid__dcgUr,\n.styles_main__BHTRd .styles_text__1_7-z {\n  margin-top: var(--padding-vertical);\n}\n\n.styles_spacer__2T7TS.styles_mid__dcgUr,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_innerMid__27MCi,\n.styles_main__BHTRd .styles_spacer__2T7TS.styles_outerMid__2WtcY {\n  margin-bottom: var(--padding-vertical);\n}\n\n/*Text*/\n.styles_text__1_7-z {\n  direction: var(--direction);\n  text-align: justify;\n  text-align-last: center;\n}\n\n.styles_text__1_7-z span {\n  pointer-events: auto;\n}\n\n.styles_main__BHTRd .styles_text__1_7-z {\n  font-family: var(--fontFamily-main);\n  font-size: var(--fontSize-main);\n  line-height: var(--lineHeight-main);\n}\n\n.styles_inner__x-amJ .styles_text__1_7-z,\n.styles_outer__abXQX .styles_text__1_7-z {\n  font-size: var(--fontSize-side);\n  line-height: var(--lineHeight-side);\n}\n\n.styles_inner__x-amJ .styles_text__1_7-z {\n  font-family: var(--fontFamily-inner);\n}\n\n.styles_outer__abXQX .styles_text__1_7-z {\n  font-family: var(--fontFamily-outer);\n}\n');const s={start:[a.spacer,a.start],mid:[a.spacer,a.mid],end:[a.spacer,a.end]},r={el:a.dafRoot,outer:{el:a.outer,spacers:s,text:a.text},inner:{el:a.inner,spacers:s,text:a.text},main:{el:a.main,spacers:{start:s.start,inner:[a.spacer,a.innerMid],outer:[a.spacer,a.outerMid]},text:a.text}};function o(e,t=""){const n=Array.prototype.find.call(document.styleSheets,(e=>e.rules[0].selectorText==`.${a.dafRoot}`)).rules[0];Object.entries(e).forEach((([e,i])=>{"string"==typeof i?n.style.setProperty(`--${t}${e}`,i):"object"==typeof i&&o(i,`${e}-`)}))}let l;var d={applyClasses(e,t=r){for(const a in e)if(a in t){const s=t[a];"object"!=typeof s||Array.isArray(s)?(n=e[a],i=s,Array.isArray(i)?n.classList.add(...i):n.classList.add(i)):this.applyClasses(e[a],s)}var n,i},updateOptionsVars(e){l=e,o(e)},updateSpacersVars(e){o(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,String(t)+"px"]))),"spacerHeights-")},updateIsAmudB(e){o({innerFloat:e?"right":"left",outerFloat:e?"left":"right"})},manageExceptions(e){e.exception?1===e.exception?(console.log("In Style Exception, Case 1"),o({hasInnerStartGap:"1",innerStartWidth:"100%",outerStartWidth:"0%",innerPadding:"0px",outerPadding:"0px"})):2===e.exception&&(console.log("In Style Exception, Case 2"),o({hasOuterStartGap:"1",outerStartWidth:"100%",innerStartWidth:"0%",innerPadding:"0px",outerPadding:"0px"})):o({hasOuterStartGap:"0",hasInnerStartGap:"0",outerStartWidth:"50%",innerStartWidth:"50%",innerPadding:l.innerPadding,outerPadding:l.outerPadding})}};function _(e,t,n,i,a){a.innerHTML="";let s=document.createElement("span");s.style.font=n+" "+String(t),s.style.lineHeight=String(i)+"px",s.innerHTML=e,s.style.position="absolute",a.append(s);const r=s.getBoundingClientRect(),o=r.height,l=r.width,d=l/a.getBoundingClientRect().width;return s.remove(),{height:o,width:l,widthProportional:d}}function h(e,t,n,i){return a=>_(a.join("<br>"),e,t,n,i).height}function c(e){const t=e.map((e=>e.widthProportional)),n=t.map(((e,t,n)=>0==t?0:Math.abs(e-n[t-1])));let i=n.reduce(((e,t,n)=>{if(n<4)return e;if(t>.12){const t=e[e.length-1];if(t&&n-t==1)return e;e.push(n)}return e}),[]);var a;return i=(a=i,a.map(((e,n)=>{let i,a;i||(i=Math.min(e+3,t.length-1)),a||(a=Math.max(e-3,0));const s=t.slice(a,e).reduce(((e,t)=>e+t))/(e-a)/t[e];let r;return r=e+1>=i?t[i]/t[e]:t.slice(e+1,i).reduce(((e,t)=>e+t))/(i-e-1)/t[e],{point:e,before:s,after:r,diff:Math.abs(r-s)}}))).sort(((e,t)=>t.diff-e.diff)).filter((({diff:e})=>e>.22)).map((({point:e})=>e)),i.sort(((e,t)=>e-t))}function p(e,t,n,i,a){const s={main:e,rashi:t,tosafot:n},r={padding:{vertical:parseFloat(i.padding.vertical),horizontal:parseFloat(i.padding.horizontal)},halfway:.01*parseFloat(i.halfway),fontFamily:i.fontFamily,fontSize:{main:i.fontSize.main,side:i.fontSize.side},lineHeight:{main:parseFloat(i.lineHeight.main),side:parseFloat(i.lineHeight.side)}},o=[r.fontFamily.main,r.fontSize.main,r.lineHeight.main],l=[r.fontFamily.inner,r.fontSize.side,r.lineHeight.side],d={};d.main=s.main.map((e=>_(e,...o,a))),["rashi","tosafot"].forEach((e=>{d[e]=s[e].map((e=>_(e,...l,a)))}));const p=h(...o,a),m=h(...l,a),u={};["rashi","tosafot","main"].forEach((e=>{u[e]=c(d[e]).filter((t=>!s[e][t].includes("hadran")))}));const g={start:4.4*r.lineHeight.side,inner:null,outer:null,end:0,exception:0},y=p(s.main);d.main.length,r.lineHeight.main;let f={inner:m(s.rashi.slice(4)),outer:m(s.tosafot.slice(4))};r.lineHeight.side,d.rashi.length,r.lineHeight.side,d.tosafot.length;switch((u.rashi.length<1||u.tosafot.length<1)&&(console.log("Dealing with Exceptions"),u.rashi.length<1&&(f.inner=r.lineHeight.side*(d.rashi.length+1),g.exception=2),u.tosafot.length<1&&(f.outer=r.lineHeight.side*(d.tosafot.length+1),g.exception=2)),u.main.length){case 0:g.inner=y,g.outer=y,2==u.rashi.length?g.end=m(s.rashi.slice(u.rashi[1])):g.end=m(s.tosafot.slice(u.tosafot[1])),console.log("Double wrap");break;case 1:if(u.rashi.length!=u.tosafot.length){if(0==u.tosafot.length){g.outer=0,g.inner=f.inner;break}if(0==u.rashi.length){g.inner=0,g.outer=f.outer;break}let e,t;1==u.rashi.length?(e="outer",t="inner"):(e="inner",t="outer"),g[t]=f[t],g[e]=y,console.log("Stairs");break}case 2:g.inner=f.inner,g.outer=f.outer,console.log("Double Extend");break;default:g.inner=f.inner,g.outer=f.outer,console.log("No Case Exception")}return g}function m(e,t){const n=document.createElement(e);return t&&t.append(n),n}function u(e){return m("div",e)}function g(e){return m("span",e)}return function(n,s=e){const r="string"==typeof n?document.querySelector(n):n;if(!(r&&r instanceof Element&&"DIV"===r.tagName.toUpperCase()))throw"Argument must be a div element or its selector";const o=u(r),l=u(r),h=u(r),m=u(r);m.id="dummy";const y={el:r,dummy:m,outer:{el:o,spacers:{start:u(o),mid:u(o),end:u(o)},text:u(o)},inner:{el:l,spacers:{start:u(l),mid:u(l),end:u(l)},text:u(l)},main:{el:h,spacers:{start:u(h),inner:u(h),outer:u(h)},text:u(h)}},f={main:g(y.main.text),inner:g(y.inner.text),outer:g(y.outer.text)},x=t(s,e);let T;return d.applyClasses(y),d.updateOptionsVars(x),{classes:a,containers:y,spacerHeights:{start:0,inner:0,outer:0,end:0},amud:"a",render(e,t,n,a="a",s,r,o){if(T&&window.removeEventListener("resize",T),this.amud!=a&&(this.amud=a,d.updateIsAmudB("b"==a)),s){let[i,r,l]=[e,t,n].map((e=>{y.dummy.innerHTML=e;const t=Array.from(y.dummy.querySelectorAll("div")).map((e=>{const t=document.createRange();return t.selectNode(e),t})),n=y.dummy.querySelectorAll(s),i=[];return n.forEach(((e,a)=>{const s=document.createRange();if(s.setEndBefore(e),0==a)s.setStart(y.dummy,0);else{const e=n[a-1];s.setStartAfter(e)}t.forEach(((e,n)=>{s.compareBoundaryPoints(Range.START_TO_START,e)<0&&s.compareBoundaryPoints(Range.END_TO_END,e)>0&&(i.push(e.extractContents()),t.splice(n,1))})),i.push(s.extractContents())})),i.map((e=>{const t=document.createElement("div");return t.append(e),t.innerHTML}))}));y.dummy.innerHTML="";const h=0!=r.length;if(h!=(0!=l.length)){const e=function(e,t,n){const i=t.fontFamily.inner,a=t.fontSize.side,s=parseFloat(t.lineHeight.side),r=c(e.map((e=>_(e,i,a,s,n))));if(3==r.length)return[e.slice(0,r[1]),e.slice(r[1])]}(h?r:l,x,m);e&&("a"==a?(r=e[0],l=e[1]):(r=e[1],l=e[0]),t=r.join("<br>"),n=l.join("<br>"))}this.spacerHeights=p(i,r,l,x,y.dummy),T=()=>{this.spacerHeights=p(i,r,l,x,y.dummy),d.updateSpacersVars(this.spacerHeights),o&&o(),console.log("resizing")},window.addEventListener("resize",T)}else this.spacerHeights=i(e,t,n,x,y.dummy),T=()=>{this.spacerHeights=i(e,t,n,x,y.dummy),d.updateSpacersVars(this.spacerHeights),console.log("resizing"),o&&o()},window.addEventListener("resize",T);d.updateSpacersVars(this.spacerHeights),d.manageExceptions(this.spacerHeights),f.main.innerHTML=e,f.inner.innerHTML=t,f.outer.innerHTML=n;const l=Math.max(...["main","inner","outer"].map((e=>y[e].el.offsetHeight)));y.el.style.height=`${l}px`,r&&r()}}}}));
